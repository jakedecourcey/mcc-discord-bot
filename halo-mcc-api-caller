import requests
import json

application_id = "876326120826470411"

def getGamertag(body):
    if "options" in body["data"]:
      return body["data"]["options"][0]["value"]
    return body["member"]["user"]["username"]

def getToken(body):
    print(body["token"])
    return body["token"]

def getCommand(body):
    print(body["data"]["name"])
    return body["data"]["name"]

def callMccApi(command, gamertag):
    url = f"https://halo.api.stdlib.com/mcc@0.1.0/{command}/"
    headers = {"content-type":"application/json"}
    r = requests.post(url + '?gamertag=' + gamertag, headers = headers)
    return json.loads(str(r.text))

def cleanStats(stats):
    stats.pop("last20")
    stats.pop("clantag")
    return stats

def formatOutput(stats):
    formatted = ""
    emblem = stats.pop("emblem")
    for key in stats:
      formatted = formatted + "\n" + f"**{key}**: " + str(stats[key])
    formatted = formatted + "\n" + emblem
    return formatted

def returnCallToDiscord(token, message):
    url = f"https://discord.com/api/v8/webhooks/{application_id}/{token}/messages/@original"
    headers = {"content-type":"application/json"}
    json = {"content":message}
    r = requests.patch(url, headers = headers, json = json)
    print(r.text)
    
def lambda_handler(event, context):
    body = event.get('body-json')
    print(event)
    print(body)
    token = getToken(body)
    gamertag = getGamertag(body)
    command = getCommand(body)
    returnCallToDiscord(token,formatOutput(cleanStats(callMccApi(command, gamertag))))
    return 0

